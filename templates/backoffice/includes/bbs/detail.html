<!-- -->
<CFSET script = LCase(GetFileFromPath(GetTemplatePath()))>
<CFIF script IS "status.cfm" OR script IS "zzz.cfm">
        <CFSET ShortBBS = True>
</CFIF>

<!-- -->
<CFSET ListBBS = True>


<!-- delete -->
<CFIF IsDefined("URL.DeleteNotes")>
        <CFQUERY NAME="Q" DATASOURCE="#DSN#">
                SELECT adminid FROM notes
                WHERE notesid = #URL.notesid#
        </CFQUERY>
        <CFIF YourID.AdminID IS Q.AdminID>
                <CFQUERY DATASOURCE="#DSN#">
                        UPDATE notes
                        SET deleted = 1
                        WHERE notesid = #URL.notesid#
                </CFQUERY>
        </CFIF>
<CFLOCATION URL="#CGI.SCRIPT_NAME#">
</CFIF>

<!-- edit -->
<CFIF IsDefined("URL.EditNotes")>
        <CFQUERY NAME="Notes" DATASOURCE="#DSN#">
                SELECT * FROM notes
                WHERE notesid = #URL.notesid#
                ORDER BY ReplyTonotesid, notesid
        </CFQUERY>
        <p>
        Edit a post.
        </p>
        <table class="inputform">
        <CFOUTPUT QUERY="Notes">
        <cfset notes_dec = Decrypt(notes,globalkey,"AES","hex")>
        <form method="post" action="#script#">
        <input type="hidden" name="notesid" value="#notesid#">
        <input type="hidden" name="ReplyTonotesid" value="#ReplyTonotesid#">
        <tr>
            <td>
            <textarea wrap=virtual cols=75 rows=16 name="Notes">#notes_dec#</textarea>
            </td>
        </tr>
        <tr>
            <td valign=top align=right> &mdash; <b>#Administrator#</b> #DateFormat(Stamp,"m/d")# #TimeFormat(Stamp,"h:mmTT")#</td>
        </tr>
        <tr>
            <td><button type="submit" class="btn" name="EDITNOTES2">Post Change</button></td>
        </tr>
        </form>
        </CFOUTPUT>
        </table>
        <CFSET ListBBS = False>
</CFIF>
<CFIF IsDefined("Form.EditNotes2")>
        <CFSET CR = Chr(13)>
        <CFSET CRLF = Chr(13) & Chr(10)>
        <CFSET TheNote=Form.Notes>
        <!---
        <CFSET TheNote = Replace(TheNote, "<", "&lt;", "ALL")>
        <CFSET TheNote = Replace(TheNote, ">", "&gt;", "ALL")>
        --->
        <CFSET TheNote = Replace(TheNote, CRLF, "<br>", "ALL")>

        <CFSET TheNote = Replace(TheNote, CR, "<br>", "ALL")>
        <cftry>
            <cfset thenote_enc = Encrypt(TheNote,globalkey,"AES","hex")>
            <cfcatch type="Any">
                <cfset thenote_enc = "">
            </cfcatch>
        </cftry>
        <CFQUERY DATASOURCE="#DSN#">
                UPDATE notes
                SET notes = '#thenote_enc#', Stamp = Now()
                WHERE notesid = #Form.notesid#
        </CFQUERY>
<CFLOCATION URL="#CGI.SCRIPT_NAME#">
</CFIF>

<!-- add -->
<CFIF IsDefined("URL.AddNotes")>
        <p>
        Add a post to the BBS.
        </p>
        <table class="inputform">
        <form method="post" action="<CFOUTPUT>#script#</CFOUTPUT>">
        <tr>
            <td><textarea wrap=virtual cols=75 rows=16 name="Notes"></textarea></td>
        </tr>
        <tr>
            <td align=right><CFOUTPUT>&mdash; <b>#YourID.user#</b> #DateFormat(Now(),"m/d")# #TimeFormat(Now(),"h:mmTT")#</CFOUTPUT></td>
        </tr>
        <tr>
            <td><button type="submit" class="btn" name="ADDNOTES2">Post</button></td>
        </tr>
        </form>
        </table>
        <CFSET ListBBS = False>
</CFIF>
<!-- ADD -->
<CFIF IsDefined("Form.AddNotes2")>
        <CFQUERY DATASOURCE="#DSN#">
                UPDATE vars
                SET notesid = notesid + 1
        </CFQUERY>
        <CFQUERY NAME="Notes" DATASOURCE="#DSN#">
                SELECT notesid FROM vars
        </CFQUERY>
        <CFQUERY NAME="Admin" DATASOURCE="#DSN#">
                SELECT user FROM admin
                WHERE AdminID = #YourID.AdminID#
        </CFQUERY>

        <CFSET CR = Chr(13)>
        <CFSET CRLF = Chr(13) & Chr(10)>
        <CFSET TheNote=Form.Notes>
        <!---
        <CFSET TheNote = Replace(TheNote, "<", "&lt;", "ALL")>
        <CFSET TheNote = Replace(TheNote, ">", "&gt;", "ALL")>
        --->
        <CFSET TheNote = Replace(TheNote, CRLF, "<br>", "ALL")>
        <CFSET TheNote = Replace(TheNote, CR, "<br>", "ALL")>
        <cftry>
            <cfset thenote_enc = Encrypt(TheNote,globalkey,"AES","hex")>
            <cfcatch type="Any">
                <cfset thenote_enc = "">
            </cfcatch>
        </cftry>
        <CFQUERY DATASOURCE="#DSN#">
        INSERT INTO notes (notesid, replytonotesid, notes, stamp, adminid, administrator,deleted)
VALUES (#Notes.notesid#, #Notes.notesid#, '#thenote_enc#', #Now()#, #YourID.AdminID#, '#Admin.user#',0)
        </CFQUERY>
<CFLOCATION URL="#CGI.SCRIPT_NAME#">
</CFIF>
<!-- reply -->
<CFIF IsDefined("URL.ReplyNotes")>

        <h3>Reply to a post.</h3>

        <!-- show message replying to -->
        <CFQUERY NAME="Notes" DATASOURCE="#DSN#">
                SELECT * FROM notes
                WHERE ReplyTonotesid = #URL.ReplyTonotesid#
                ORDER BY ReplyTonotesid DESC, notesid
        </CFQUERY>
        <CFSET RepID = 0>
        <table class="inputform">
        <CFOUTPUT QUERY="Notes">
                <cfset notes_dec = Decrypt(notes,globalkey,"AES","hex")>
                <CFSET x = Now() - Stamp>
                <CFIF x LT 0.25>
                        <CFSET msg = 'bbsnew'><CFELSEIF x LT 1><CFSET msg = 'bbsrecent'><CFELSE><CFSET msg = 'bbs'></CFIF><CFIF Deleted><CFSET msg='bbsdeleted'>
                </CFIF>
                <tr>
                        <td class=#msg#><p class=bbs>#notes_dec# -- <b>#Administrator#</b> #DateFormat(Stamp,"m/d")# #TimeFormat(Stamp,"h:mmTT")#</p></td>
                </tr>
        </CFOUTPUT>
        </table>

        <CFOUTPUT>
        <table class="inputform">
        <form method="post" action="#script#">
        <input type="hidden" name="ReplyTonotesid" value="#URL.ReplyTonotesid#">
        <tr>
            <td valign=top><textarea wrap=virtual cols=75 rows=16 name="Notes"></textarea></td>
        </tr>
        <tr>
            <td valign=top align=right> &mdash; <b>#YourID.user#</b> #DateFormat(Now(),"m/d")# #TimeFormat(Now(),"h:mmTT")#</td>
        </tr>
        <tr>
            <td><button type="submit" class="btn" name="REPLYNOTES2">Post</button></td>
        </tr>
        </form>
        </table>
        </CFOUTPUT>
        <CFSET ListBBS = False>
</CFIF>
<!-- reply -->
<CFIF IsDefined("Form.ReplyNotes2")>

        <!-- reply -->
        <CFQUERY DATASOURCE="#DSN#">
                UPDATE vars
                SET notesid = notesid + 1
        </CFQUERY>
        <CFQUERY NAME="Notes" DATASOURCE="#DSN#">
                SELECT notesid FROM vars
        </CFQUERY>
        <CFQUERY NAME="Admin" DATASOURCE="#DSN#">
                SELECT user FROM admin
                WHERE AdminID = #YourID.AdminID#
        </CFQUERY>

        <CFSET CR = Chr(13)>
       <CFSET CRLF = Chr(13) & Chr(10)>
        <CFSET TheNote=Form.Notes>
        <!---
        <CFSET TheNote = Replace(TheNote, "<", "&lt;", "ALL")>
        <CFSET TheNote = Replace(TheNote, ">", "&gt;", "ALL")>
        --->
        <CFSET TheNote = Replace(TheNote, CRLF, "<br>", "ALL")>
        <CFSET TheNote = Replace(TheNote, CR, "<br>", "ALL")>
        <cftry>
            <cfset thenote_enc = Encrypt(TheNote,globalkey,"AES","hex")>
            <cfcatch type="Any">
                <cfset thenote_enc = "">
            </cfcatch>
        </cftry>
        <CFQUERY DATASOURCE="#DSN#">
                INSERT INTO notes (notesid, ReplyTonotesid, Notes, Stamp, AdminID, Administrator,deleted)
                VALUES (#Notes.notesid#, #Form.ReplyTonotesid#, '#thenote_enc#', Now(), #YourID.AdminID#, '#Admin.user#',0 )
        </CFQUERY>
<CFLOCATION URL="#CGI.SCRIPT_NAME#">
</CFIF>

<!-- LIST -->
<CFIF ListBBS IS True>
        <CFIF IsDefined("ShortBBS")>
                <CFQUERY NAME="Notes" DATASOURCE="#DSN#">
                        SELECT * FROM notes
                        WHERE Stamp > #Dateadd("d",-3,Now())# AND Deleted = 0
                        ORDER BY ReplyTonotesid DESC, notesid
                </CFQUERY>
        <CFELSE>
                <CFQUERY NAME="Notes" DATASOURCE="#DSN#">
                        SELECT * FROM notes
                        ORDER BY ReplyTonotesid DESC, notesid
                </CFQUERY>
        </CFIF>
        <CFSET RepID = 0>

        <CFOUTPUT QUERY="Notes">
                <cfset notes_dec = Decrypt(notes,globalkey,"AES","hex")>
		<div class="bbsnote
                <CFIF ReplyTonotesid IS NOT notesid> reply
                        <CFSET RepID = #ReplyTonotesid#>
                </CFIF>
                <CFSET x = Now() - Stamp>
                <CFIF x LT 0.25>
                        <CFSET msg = 'bbsnew'><CFELSEIF x LT 1><CFSET msg = 'bbsrecent'><CFELSE><CFSET msg = 'bbs'></CFIF><CFIF Deleted><CFSET msg='bbsdeleted'>
                </CFIF>
#msg#">

			<div class="bbsinfo">
			<b>#Administrator#</b> #DateFormat(Stamp,"m/d")# #TimeFormat(Stamp,"h:mmTT")#
			<CFIF NOT Deleted>
				<a class="submenu" href="#script#?notesid=#notesid#&ReplyTonotesid=#ReplyTonotesid#&ReplyNotes=">Reply</a>
				<CFIF YourID.AdminID IS AdminID>
					<a class="submenu" href="#script#?notesid=#notesid#&ReplyTonotesid=#ReplyTonotesid#&EditNotes=">Edit</a>
					<a class="submenu" href="#script#?notesid=#notesid#&DeleteNotes=">Delete</a>
				</CFIF>
			</CFIF>
			</div>
			<div class="bbsnotetext">
			#notes_dec#
			</div>
		</div>
        </CFOUTPUT>

        <small>
        <font color="#202020">
        <b><font color="#ff0000">Red</font></b>, less than 6hrs<Br>
        <b><font color="#ff8080">Pink</font></b>, less than 2days<br>
        <b><font color="#000">White</font></b>, All other<br>
        <CFIF IsDefined("ShortBBS")>Shows messages from the last three (3)
days.
<br></CFIF>
        </font>
        </small>
</CFIF>

