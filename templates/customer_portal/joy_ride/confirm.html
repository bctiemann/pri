{% extends "customer_portal/base.html" %}

{% comment %}
<!--- If a form was submitted, the user had JS turned off, so we have to process the sequential logic. --->
<cfset fieldErrors = StructNew()>
<cfset formError = "">
<cfif IsDefined("Form.confcode")>

    <!--- Validate the first page (identity and rental date/specs) --->
    <cfset ret = StructAppend(Form, Variables)>
    <cfinvoke
        component="cfc/cassidy"
        method="#Form.method#"
        returnVariable="JoyPerfResult"
        argumentCollection="#Form#">
    </cfinvoke>
    <cfset fieldErrors = JoyPerfResult.fieldErrors>

    <!--- Push to customer portal if successful --->
    <cfif JoyPerfResult.success>
        <cfset redirectUrl = #OnCustSite# & "joyride_confirm.cfm?confcode=" & Form.confcode>
        <cflocation url=#redirectUrl#>
    </cfif>

    <cfset Customer = Form>
    <cfset formError = NOT JoyPerfResult.success ? JoyPerfResult.error : "">

<!--- If the user has JS on, pull a blank Customer object to populate the form --->
<cfelse>

</cfif>

<cfset confcode = IsDefined("Form.confcode") ? Form.confcode : URL.confcode>

<CFINCLUDE TEMPLATE="inc_lib.cfm">
<CFINCLUDE TEMPLATE="inc_header.cfm">
<title>Performance Rentals Customer Portal</title>
<CFINCLUDE TEMPLATE="inc_meta.cfm">
<CFINCLUDE TEMPLATE="inc_styles.cfm">
<CFINCLUDE TEMPLATE="inc_js.cfm">
</head>
<body>

<CFINCLUDE TEMPLATE="inc_states.cfm">
<cfset selectedPage="joyride">

<table class="layout">
<tr>
<td class="sidebar">
    <cfinclude template="inc_sidebar.cfm">
</td>
<td class="main">

    <div class="wrapper">

    <CFINCLUDE TEMPLATE="inc_contentheader.cfm">

    <div class="well">
        <div class='section-header'>Joy Ride</div>
{% endcomment %}

        {% block page_title %}Joy Ride{% endblock %}

        {% block content %}
        <cftry>

            <cfif confcode IS "">
                <cfthrow message="Invalid confirmation code.">
            </cfif>

            {% comment %}
            <cfquery name="JoyRide" datasource="#DSN#">
                SELECT joyperfid,confcode,reqdate,bupdate,JoyPerf.notes,
                V1.make AS v1_make,V1.model AS v1_model,V1.year AS v1_year,
                V2.make AS v2_make,V2.model AS v2_model,V2.year AS v2_year,
                V3.make AS v3_make,V3.model AS v3_model,V3.year AS v3_year
                FROM JoyPerf
                LEFT JOIN Vehicles V1 ON V1.vehicleid=JoyPerf.choice1
                LEFT JOIN Vehicles V2 ON V2.vehicleid=JoyPerf.choice2
                LEFT JOIN Vehicles V3 ON V3.vehicleid=JoyPerf.choice3
                WHERE confcode = <CFQUERYPARAM value="#confcode#" CFSQLType="CF_SQL_VARCHAR">
                AND customerid = <CFQUERYPARAM value="#YourID.customerid#" CFSQLType="CF_SQL_INTEGER">
            </cfquery>
            {% endcomment %}

            <div class="reservation-info">
            <p>
            Thank you for your reservation! Your Joy Ride is now booked for the date(s) you indicated, with the vehicles you chose (pending availability).
            We will follow up with you to provide details on the event (the meeting location, time, etc.); we'll also contact you if we have any difficulty scheduling
            the vehicles of your choice.
            </p>
            </div>

            <cfoutput query="JoyRide">

            <div class="confcode-container">
                <p>Confirmation code:</p>
                <div class="confcode">{{ joyride.confirmation_code }}</div>
            </div>

            <table class="reservation-details small-item-data">
                <tr>
                    <td>Vehicle 1:</td>
                    <td>{{ joyride.vehicle_choice_1.make }} {{ joyride.vehicle_choice_1.model }}</td>
                </tr>
                <tr>
                    <td>Vehicle 2:</td>
                    <td>{{ joyride.vehicle_choice_2.make }} {{ joyride.vehicle_choice_2.model }}</td>
                </tr>
                <tr>
                    <td>Vehicle 3:</td>
                    <td>{{ joyride.vehicle_choice_3.make }} {{ joyride.vehicle_choice_3.model }}</td>
                </tr>
                <tr>
                    <td>Requested Date:</td>
                    <td>{{ joyride.requested_date|date:"D m/d/Y" }}</td>
                </tr>
                <tr>
                    <td>Alternate Date:</td>
                    <td>{{ joyride.backup_date|date:"D m/d/Y" }}</td>
                </tr>
            </table>
            </cfoutput>

            {% comment %}
            <cfif YourID.firsttime IS 1>
                <cftry>
                    <cfset pass_dec = Decrypt(CustFront.password,globalkey,"AES","hex")>
                    <cfcatch type="Any">
                        <cfset pass_dec = "">
                    </cfcatch>
                </cftry>
                <cfoutput>
                <div class="exception alert password-banner">
                    <p>Your temporary password is: <span class="password">#pass_dec#</span></p>
                    <p>When you're done here, please change your password using the <b>Change Password</b> option at left.</p>
                </div>
                </cfoutput>
            </cfif>
            {% endcomment %}

{#            <cfif True>#}

                <form method="POST" name="reservation_form" action="{% url "customer_portal:joyride-confirm" confirmation_code=joyride.confirmation_code %}" autocomplete="on">

                <cfoutput query="JoyRide">
                <table class="inputform rentalinfo">

                <thead>
                <tr>
                    <th colspan="2">
                        <div class="form-section-header">
                        <h3>Event Notes</h3>
                        <p>
                        Please let us know if you've got any special requests or notes for your event.
                        </p>
                        </div>
                    </h3>
                </tr>
                </thead>

                <tbody>
                <tr>
                    <td class="align-top">Notes/Requests</td>
                    <td>
                        {{ form.customer_notes }}
{#                        <cftextarea name="notes" id="notes" class="#StructKeyExists(fieldErrors,"notes") ? 'field-error' : ''#">#notes#</cftextarea>#}
                    </td>
                </tr>

                <tr class="buttons">
                    <td></td>
                    <td><button type="submit" class="btn">Update</button></td>
                </tr>
                </tbody>

                </table>
                </cfoutput>

                {% csrf_token %}
                <cfinput name="method" type="hidden" value="updateJoyPerfNotes" />
                <cfinput name="confcode" type="hidden" value="#confcode#" />
                <cfinput name="joyperfid" type="hidden" value="#JoyRide.joyperfid#" />
                </form>

{#            </cfif>#}

            {% comment %}
            <cfcatch type="Any">
                <cfoutput>
                <div class="exception">
                    <h3>An error occurred</h3>
                    <p class="alert-message">#cfcatch.message & " " & cfcatch.detail#</p>
                </div>
                </cfoutput>
            </cfcatch>
        </cftry>
        {% endcomment %}
        {% endblock %}
    </div>

    <div class="push"></div>
    </div>

    <CFINCLUDE TEMPLATE="inc_footer.cfm">

</td>
</tr>
</table>


</body>
</html>


